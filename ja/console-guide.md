
## Content Delivery > CDN > コンソール使用ガイド

ここでは、コンソールからCDNサービスを構成して利用する方法を説明します。

## CDNサービス作成順序

**Contents Delivery > CDNのCDNサービス**タブで**作成**ボタンをクリックすると、**CDNサービス作成**ウィンドウが表示されます。
CDNサービスに利用するドメイン名は自動的に作成されます。所有しているドメインがある場合、ドメインエイリアス(Domain Alias)機能を利用してサービスできます。

### CDNサービス

![cdn_01_201812](https://static.toastoven.net/prod_cdn/cdn_01_201812.png)

- **サービス**
 サービスする地域を選択します。
 サービス提供形態に応じて、KOREAまたはGLOBALを選択できます。各国に存在するキャッシュサーバーを利用して全世界を対象にサービスするにはGLOBALを選択し、韓国内でのみサービスするにはKOREAを選択します。 
 KOREAを選択した場合、さらに安い価格でサービスを利用できます。

- **説明**
  CDNサービスに追加説明を入力します。

- **原本サーバー**
  TOASTで作成したインスタンスや既に保有しているサーバーを利用してサービスできます。原本サーバーはIPまたはドメイン形式で入力でき、ポートを指定できます。
- **ソースパス**
  URLパス形式の下層パスは、'/'を含めてソースパスに入力してください。**ソースパス**は任意項目です。

- **ドメインエイリアス**
 ドメインエイリアスを設定します。
  CDNサービスの作成が完了したら、 *.cdn.toastcloud.com形式のサービスドメインが自動的に発行され、発行されたドメインをそのままサービスに利用できます。
  しかし個人または会社が所有しているドメインを利用してCDNサービスを提供する必要がある場合は、**ドメインエイリアス**設定を利用できます。
  **ドメインエイリアス**を利用すると、TOASTで提供するドメインの他に個人または会社が所有しているドメインでもCDNサービスを使用できます。
  **ドメインエイリアス**に所有しているドメインアドレスを入力し、該当ドメインのネームサーバー設定を変更してください。
  TOASTで発行されたCDNサービスアドレスをCNAMEレコードに追加すると、所有しているドメインでもサービスできます。

> [注意]
> CDNサービスが作成されたら`*.cdn.toastcloud.com`サービスドメインが発行されます。
> `*.cdn.toastcloud.com`サービスドメインからリソースにアクセスできない時は、下記の内容を確認してください。
> 
> 
> 1. CDNサービス状態が'緑色'(サービス中)状態になっているか確認してください。
> 2. 原本サーバー(origin server)で特定ホストのアクセスのみ許可しているかを確認してください。
> 3. ユーザーがCDNサービスドメインからリソースを要求する場合、`Host`リクエストヘッダはユーザーが要求したアドレスである`*.cdn.toastcloud.com`に設定され、原本サーバーにリクエストします。
> したがって、原本サーバーで`*.cdn.toastcloud.com`ホストに対するアクセスが許可されていない場合、CDNキャッシュサーバーは原本サーバーからリソースを取得できません。
> この場合、原本サーバーのVirtual host設定に`*.cdn.toastcloud.com`ホストを登録する必要があります。

* ドメインエイリアスの使用例

CDNサービスを作成した後、random-exam.cdn.toastcloud.comというドメインが発行され、既存の顧客が所有していたalias.nhnentcustomer.comを利用してサービスするための設定方法です。

  1. Toast CDN作成後、自動的に発行されたrandom-exam.cdn.toastcloud.comを確認します。
  2. 基本情報設定タブのDomain Alias項目に、サービスに使用する顧客ドメインalias.nhnentcustomer.comを入力します。
  3. nhnentcustomer.comネームサーバー管理項目で、random-exam.cdn.toastcloud.comを利用してCNAMEレコードを追加します。 (ドメイン提供企業によって設定方法は異なることがあります。詳細はドメイン提供企業にお問い合わせください。)
  4. alias.nhnentcustomer.comでサービスを開始します。

### キャッシュ

キャッシュの下でキャッシュ満了を設定できます。
![cdn_02_201812](https://static.toastoven.net/prod_cdn/cdn_02_201812.png)

- **キャッシュ満了設定**
希望するキャッシュ満了時間を指定できます。**原本設定を使用**オプションがデフォルト値です。

  * 原本設定を使用：原本サーバーのキャッシュ満了設定を利用するように設定します。
  * ユーザー設定を使用：希望するキャッシュ満了時間を設定できます。

- **キャッシュ満了時間(秒)**
キャッシュ満了時間を指定するには、**ユーザー設定を使用**ボタンをクリックして**キャッシュ満了時間(秒)**でキャッシュ満了時間を変更します。

> [注意]
> 原本サーバー設定にキャッシュ満了時間が指定されている場合、コンソールで設定した**キャッシュ満了時間(秒)**値は無視されます。
> CDNサービスを利用して満了時間を指定したい場合、原本サーバーのキャッシュ満了設定を削除します。
>
> [参考]
> キャッシュ満了時間のデフォルト値は0です。デフォルト値を0に設定した場合のキャッシュ満了時間は、604,800(単位/秒)です。
> キャッシュ満了時間は、デフォルト値の0から2,147,483,647(単位/秒)まで入力できます。

- **リファラー(referrer)ヘッダアクセス管理**
 リファラーアクセス管理を設定します。
 Webページでユーザーコンテンツをリンクしてリソースを要求する場合、リファラーヘッダにリンクしたURLのパスが伝達され、どのパスから要求が流入したのかを知ることができます。
 リファラーアクセス管理は、リファラーヘッダを参照して特定リファラーのみユーザーコンテンツにアクセスできるように設定できます。
 リファラーは、正規表現で入力でき、複数のリファラーを制御する場合、入力ウィンドウにラインを追加して入力します。

  * Blacklist(ブラックリスト)タイプ：
      * 特定リファラーからのアクセスを制限する場合に適しています。
      * リクエストヘッダのリファラー値が、設定した正規表現にマッチする文字列の場合、コンテンツへのアクセスが制限されます。マッチしない文字列の場合は、コンテンツへのアクセスが許可されます。
  * Whitelist(ホワイトリスト)タイプ：
      * 特定リファラーからのみアクセスを許可する場合に適しています。
      * リクエストヘッダのリファラー値が正規表現にマッチする文字列の場合、コンテンツへのアクセスが許可されます。マッチしない文字列の場合は、コンテンツへのアクセスが制限されます。

> [注意]
> リクエストヘッダにリファラーがない時は、リファラー設定のアクセス制御が動作しません。
>
> [例]
> * タイプ：Whitelist
> * 正規表現：`^https://[a-zA-Z0-9._-]*\.toast\.com/.*`
> 任意のtoast.comサブドメインの下層パスからリソースを要求した場合にのみ、コンテンツアクセスを許可するようになります。
>
> [参考]
> 一部の文字は、正規表現で特殊文字として扱われます。
> ピリオド(`.`)を例に挙げると、正規表現でピリオド(`.`)は、すべての文字にマッチする特殊文字です。
> 特殊文字としての意味ではない一般文字そのままの解釈が必要な場合は、エスケープ文字バックスラッシュ(`\`)を特殊文字の前に追加してください。(例： `\.`)
> 正規表現の特殊文字は`^ . [ ] $ ( ) | * + ? { } \`などがあります。
> 複数のリファラーを制御する場合、次のラインに連続して入力します。
> APIで複数のリファラーを設定する時は\nトークンで区分して入力します。


### コールバック

CDNサービス変更作業(作成、修正、停止/再開、削除作業)は変更要請後、最長で数十分かかることがあります。
サービス変更作業が完了した後、あらかじめ設定したコールバックURLにサービス変更作業の完了の有無と、サービス情報を受け取ることができます。

![cdn_03_201812](https://static.toastoven.net/prod_cdn/cdn_03_201812.png)


1. **HTTP Method**と**コールバックURL**を入力します。
2. Request URIのQuery ParameterでCDNサービス変更作業の結果を受け取るには、**コールバックURL**にPath変数を含めて入力してください。

| Path Variable | 説明 | サンプル伝達値  |
| ------------- | --- | ------- |
| {appKey} | CDNサービスのアプリキー | コンソールで発行されたアプリキー |
| {domain} | CDNサービス名 | xxxxxx.cdn.toastcloud.com |
| {status} | 現在CDNサービスの状態 | OPEN, SUSPEND, CLOSE, ERROR |
| {isSuccessful} | サービス変更作業が成功したか(API V1.0はサポートしません) | "true"または"false" |

**確認**ボタンをクリックすると、CDNサービスの作成要求が完了します。

>例
> GET http://test.callback.com?appKey={appKey}&domain={domain}&status={status}&deploySuccess={isSuccessful}
* コールバック伝達時、CDNサービスの情報をリクエスト本文(Request Body)に渡します。
  * API V1.0で変更する場合のリクエスト本文の内容は下記の通りです。
```
    {
      "seq": Integer,
      "appKey": String,
      "domain": String,
      "domainAlias": String,
      "type": String,
      "region": String,
      "description": String,
      "status": String, 
      "createTime": DateTime,
      "useOrigin": String,
      "maxAge": String,
      "referrerType": String,
      "referrers": String,
      "deleteTime": DateTime,
      "company": String,
      "origins":[
      {
         "seq": Integer,
         "distributionSeq": Integer,
         "origin": String,
         "originPath": String,
         "port":Integer,
      }
      ],
      "callbackHttpMethod": String,
      "callbackUrl": String
}
```
* CDNコンソールで変更したり、API V1.5で変更する場合のレスポンス形式は下記の通りです。
```
    {
      "header":{
      "resultCode": Integer,
      "resultMessage": String,
      "isSuccessful": Boolean
      },
      "distribution":{
      "seq": String,
      "appKey": String,
      "domain": String,
      "domainAlias": String,
      "type": String,
      "region": String,
      "description": String,
      "status": String,
      "createTime": DateTime,
      "useOrigin": String,
      "maxAge": String, 
      "referrerType": String,
      "referrers": String,
      "deleteTime": DateTime,
      "company": String,
      "origins":[
         {
            "seq": Integer,
            "distributionSeq": Integer,
            "origin": String,
            "originPath": String,
            "port": Integer
         }
      ],
      "callback":{
         "httpMethod": String,
         "url": String
      }
      },
      "successful": Boolean
}
```
> [注意]
> API V1.0とV1.5バージョンでは、コールバック動作が変わる点に注意してください。
> API V1.0は、CDNサービス作成と修正時のみコールバックが呼び出され、API V1.5は作成、修正、一時停止と再開、削除時にコールバックを呼び出します。
> APIバージョンによってコールバックリクエスト本文(Request Body)のjsonデータ形式が変わる点に注意してください。


**作成要求後、サービス配布が完了するまで、数十分程度(最大1時間)かかります。配布が完了した後、サービスを利用できます。**

## 設定

### CDNサービスの設定変更

追加説明および原本サーバー情報を変更できます。
しかしサービス名と地域は変更できないので、変更したい場合は既存サービスを削除した後、新しいサービスを作成する必要があります。

1. 変更したいサービスをCDNサービスリストから選択します。
2. 画面下の**基本情報**タブの**修正**ボタンをクリックします。

次のように変更可能な項目が有効になります。

![cdn_04_201812](https://static.toastoven.net/prod_cdn/cdn_04_201812.png)

* 変更可能な項目は、説明、原本サーバー情報、ドメインエイリアス、コールバックです。
* **確認**ボタンをクリックして、変更を完了します。

**原本サーバーが変更されると、既にキャッシュされていたすべての内容が再配布されます。コンテンツ量に応じて再配布時間は異なります。**

### CDNキャッシュの設定変更

1. 変更したいサービスをCDNサービスリストから選択します。
2. **キャッシュ設定**タブの**修正**ボタンをクリックします。

次のように変更できる項目が有効になります。

![cdn_05_201812](https://static.toastoven.net/prod_cdn/cdn_05_201812.png)

* 変更できる項目は、キャッシュ満了設定、キャッシュ満了時間、リファラーヘッダアクセス管理、コールバックです。
* **確認**ボタンをクリックして、変更を完了します。

### CDNキャッシュの再配布

原本コンテンツの内容が変更された場合、既に指定されているキャッシュ満了時間以降は、キャッシュが新しいコンテンツにアップデートされます。しかし迅速にキャッシュ内容を再配布したい場合は、**キャッシュ再配布**機能を利用して既存キャッシュを新しいコンテンツにアップデートします。

1. 変更したいサービスをCDNサービスリストから選択します。
2. **キャッシュ再配布**タブをクリックします。
![cdn_06_201812](https://static.toastoven.net/prod_cdn/cdn_06_201812.png)
3. キャッシュ再配布タイプを選択します。3つのタイプから選択できます。
  * 特定ファイル：正確なファイル名とパスを設定して、希望するファイルのみを再配布できます。
      * 例) /path/to/file1.jpg
  * ワイルドカード：ファイル名とパス名にワイルドカード文字を利用できます。
      * \*：任意の文字列
      * ?：1個の文字
      * \：エスケープ文字
          * 例) /images/games/\*.jpg
          * /\_/sports/\_.jpg
          * /images/sports/ac?e/\*.jpg
  * 全体ファイル：すべてのキャッシュを一度に再配布します。
4. 選択したキャッシュ再配布タイプに合わせて、再配布するファイルを指定します。
5. **キャッシュ再配布**ボタンをクリックして、再配布を要請します。

再配布には数分かかります。容量によって必要な時間が変わることがあります。

> [注意]キャッシュ再配布使用量制限
> サービス別にキャッシュ再配布使用回数が制限されるので、制限使用量を越えた場合、使用量が初期化された後に再度使用できます。
> 
> 
> * 特定ファイルタイプ：1時間あたり60回制限、一度に要請できる最大Path数は1000個
> * ワイルドカードタイプ：1時間あたり60回制限、一度に要請できる最大Path数は10個
> * 全体ファイルタイプ：1時間あたり5回制限

### CDN監視設定

予期せぬトラフィックが発生した場合に備えて、監視設定を登録できます。指定した値以上のトラフィックが発生した場合、メールを送信して強制停止オプションを設定すると、メール送信後にCDNサービスを停止します。

1. 変更したいサービスをCDNサービスリストから選択します。
2. **監視設定**タブの**修正**ボタンをクリックします。
![cdn_07_201812](https://static.toastoven.net/prod_cdn/cdn_07_201812.png)
  * 累積トラフィックタイプで制限するトラフィック量を指定します。単位はバイトです。
  * +/- ボタンをクリックして、複数の監視設定を追加したり削除します。
  * 指定した値以上のトラフィックが感知された時に、サービスを強制停止させたい場合は、強制停止設定を**はい**にすると有効になります。
3. **確認**ボタンをクリックして、変更された内容を適用します。

## 統計

ネットワーク伝送量、HTTP状態コード別の統計および、ダウンロードが最も多いコンテンツの順位統計を確認できます。
1. **Contents Delivery > CDN**の**統計**タブをクリックします。
![cdn_08_201812](https://static.toastoven.net/prod_cdn/cdn_08_201812.png)
2. 統計を確認するには、CDNサービスを選択します。
3. 検索期間を入力します。
4. 検索期間内のデータ周期は、選択した期間によって自動的に選択されます。
5. **検索**ボタンをクリックします。
